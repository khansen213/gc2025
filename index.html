<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>General Conference Originals Challenge ‚Äî Alien Wizard</title>
<meta name="description" content="A whimsical, accessible one-page app for General Conference participants to plan a five-session Originals Challenge hosted by an Alien Wizard." />
<meta property="og:title" content="General Conference Originals Challenge ‚Äî Alien Wizard" />
<meta property="og:description" content="Plan your five-session Originals Challenge line-up, see the rules & scoring, and submit a printout ‚Äî one shot only." />
<link rel="stylesheet" href="dialog.css">
<style>
  :root{
    --ink:#121212; --bone:#F7F5FF; --violet:#2A0F45; --purple:#3B1D5A;
    --orange:#FF7A1A; --yellow:#FFD74A; --green:#2FBF71; --leaf:#35C77E;
    --lilac:#E9D7FF; --ember:#FF3B30; --berry:#9C5BFF;
    --focus:#FFD74A; --ring:3px; --gap:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--violet);color:var(--bone);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  /* Snap scrolling container */
  main{
    height:100vh;overflow:auto;scroll-snap-type:y mandatory;
  }
  section{
    min-height:100vh;scroll-snap-align:start;display:grid;place-items:center;position:relative;padding:24px;
  }
  h1,h2,h3{margin:.2em 0 .6em}
  h1{font-size:clamp(28px,4vw,40px)}
  h2{font-size:clamp(22px,3vw,30px)}
  p{max-width:75ch}
  .card{
    background:rgba(18,18,18,.6);backdrop-filter:blur(6px);
    border:2px solid rgba(255,255,255,.15);border-radius:16px;padding:24px;max-width:1100px;width:100%;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  .grid{display:grid;gap:var(--gap)}
  .two{grid-template-columns:1fr 1fr}
  .three{grid-template-columns:repeat(3,1fr)}
  @media (max-width:900px){.two,.three{grid-template-columns:1fr}}
  
  /* Buttons/inputs */
  button,.btn{
    background:var(--orange);color:black;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
  }
  button.secondary{background:transparent;color:var(--bone);border:2px solid var(--bone)}
  button:focus, .input:focus, select:focus, textarea:focus, .pill:focus, .slot:focus{
    outline:var(--ring) solid var(--focus);outline-offset:2px;
  }
  .muted{opacity:.8}
  label{font-weight:600}
  .input,select,textarea{
    background:#1d1533;color:var(--bone);border:1px solid #5f4b8a;border-radius:10px;padding:10px;width:100%;
  }
  .ok{color:#00e676}
  .bad{color:var(--ember)}
  
  /* Emoji icon row */
  .icons{font-size:28px;display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:12px}
  .icons[aria-hidden="true"]{user-select:none}
  
  /* Warp background blob */
  .warp{
    position:fixed;inset:auto;top:50%;left:50%;width:70vmax;height:70vmax;pointer-events:none;z-index:-1;
    background:radial-gradient(40% 40% at 50% 50%, rgba(255,215,74,.25), transparent 60%),
    conic-gradient(from 90deg, rgba(255,122,26,.18), rgba(53,199,126,.18), rgba(156,91,255,.18), rgba(255,122,26,.18));
    filter:blur(50px);border-radius:50%;
    transform:translate(-50%,-50%) scale(1) rotate(0deg);
    transition:transform .6s ease;
  }
  @media (prefers-reduced-motion:reduce){
    .warp{transition:none}
  }

  /* Gate */
  .gate-wrap{display:grid;gap:12px;justify-items:center}
  .code{font:700 20px/1 monospace;letter-spacing:2px;text-align:center}
  
  /* Rules wiggle */
  .wiggle{animation:wig .4s ease}
  @keyframes wig{
    0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}
  }
  @media (prefers-reduced-motion:reduce){
    .wiggle{animation:none}
  }

  /* Tables for scoring */
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{font-size:14px;text-transform:uppercase;letter-spacing:.08em;opacity:.9}
  td,th{padding:12px 10px;vertical-align:top}
  tr{
    background:#1b1330;border:2px solid #5f4b8a;
  }
  .num{white-space:nowrap;font-weight:800;font-size:18px}
  .plus{color:#0be881}
  .minus{color:#ff5e57}
  .tbl-title{font-size:20px;margin:.2em 0 .4em;font-weight:800}
  .note{font-size:13px;opacity:.9}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#2a1f47;border:1px solid #5f4b8a;font-size:12px}
  
  /* DnD */
  .palette,.lineup{display:grid;gap:10px}
  .palette{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .pill{
    background:#2a1f47;border:2px solid #6b56a8;color:#fff;border-radius:999px;padding:10px 12px;
    display:flex;justify-content:space-between;align-items:center;gap:8px;cursor:grab;
  }
  .pill:active{cursor:grabbing}
  .pill small{opacity:.85}
  .slots{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  @media (max-width:920px){.slots{grid-template-columns:1fr}}
  .slot{
    min-height:62px;background:#20173a;border:2px dashed #6b56a8;border-radius:12px;padding:8px;display:grid;align-content:center;gap:6px
  }
  .slot .slabel{font-size:12px;opacity:.8}
  .slot .inside{display:flex;gap:6px;flex-wrap:wrap}
  .slot .smallpill{
    background:#3b2a66;border:2px solid #7d67bf;border-radius:999px;padding:6px 10px;font-size:14px;display:inline-flex;gap:6px;align-items:center
  }
  .xbtn{background:transparent;border:0;color:#fff;font-weight:900;cursor:pointer}
  .dim{opacity:.6}
  
  /* Details panels */
  .details-grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
  @media (max-width:1000px){.details-grid{grid-template-columns:1fr}}
  .tokenbox{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .token{background:#3b2a66;border:2px solid #7d67bf;border-radius:999px;padding:6px 10px}
  .token button{margin-left:6px}
  .bank{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:1000px){.bank{grid-template-columns:repeat(2,1fr)}}
  
  /* Modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:50}
  .modal{background:#1b1330;border:2px solid #5f4b8a;border-radius:14px;max-width:520px;width:92%;padding:20px}
  .modal.show+.modal-back, .modal-back.show{display:grid}
  
  /* Nav hints */
  .navhint{font-size:13px;opacity:.9}
  
  /* Submit/locked */
  .center{display:grid;justify-items:center;gap:10px}
  
  /* Full-page lock overlay for the access gate */
  #sec-gate{
    position:fixed; inset:0; z-index:100; 
    display:none; /* shown only when locked */
    background:linear-gradient(145deg,#2A0F45,#3B1D5A);
    scroll-snap-align:none; /* gate is not a snap section */
  }
  #sec-gate.locked{ display:grid; place-items:center; }
  
  /* When locked, main content can't scroll */
  .locked-scroll-freeze{
    overflow:hidden !important;
    height:100vh !important;
  }
  
  /* --- REQUIRED FIELD STATES --- */
  .invalid{ border-color:#FF3B30 !important; box-shadow:0 0 0 2px rgba(255,59,48,.35) !important; }
  .field-hint{ font-size:12px; color:#FF3B30; margin-top:6px; }
  /* Optional: rules card footer layout */
  .card-footer{ margin-top:12px; padding-top:12px; border-top:1px dashed rgba(255,255,255,.25); }
</style>
<script src="quest-hud.min.js" defer></script>
</head>
<body>
<div class="warp" id="warp" aria-hidden="true"></div>

<main id="scroller" tabindex="-1" aria-label="General Conference Originals single-page flow">
  <!-- 0: ACCESS GATE -->
  <section id="sec-gate" aria-labelledby="h-gate">
    <div class="card gate-wrap" role="dialog" aria-modal="true" aria-describedby="d-gate">
      <div class="icons" aria-hidden="true">üõ∏ üåå üßô‚Äç‚ôÇÔ∏è</div>
      <h1 id="h-gate">Enter Access Code</h1>
      <p id="d-gate">Please enter your 4-digit access code. Codes are provided by the organizer. If you‚Äôve already submitted, you‚Äôll see a lockout message.</p>
      <input id="code" class="input code" inputmode="numeric" autocomplete="one-time-code" maxlength="4" placeholder="____" aria-label="4-digit access code" />
      <div id="gate-msg" class="muted" role="status" aria-live="polite"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btn-enter">Unlock</button>
        <button id="btn-clear" class="secondary" title="Clear local access flag">Reset Local Access</button>
      </div>
      <div class="navhint">Tip: Press Enter to submit.</div>
    </div>
  </section>

  <!-- 1: INTRO -->
  <section id="sec-intro" aria-labelledby="h-intro">
    <div class="card">
      <div class="icons" aria-hidden="true">üåå üßô‚Äç‚ôÇÔ∏è üìú</div>
      <h1 id="h-intro">The General Conference Originals Challenge</h1>
      <p>
        Welcome, traveler. An Alien Wizard‚Äîonce a toad, then a prince, now a teacher‚Äîhas arrived for General Conference seeking minds that make <em>new paths</em>.
        Across five sessions you will choose exactly five activities (one per session). One may be a Freebie. Think quietly for a minute (no timer), then prepare your plan.
      </p>
      <div class="grid two" style="margin-top:12px">
        <div>
          <label for="alias">Legend Alias</label>
          <input id="alias" class="input" placeholder="e.g., Star-Mapper, Aurora Scribe" />
        </div>
        <div>
          <label for="fname">Real First Name</label>
          <input id="fname" class="input" placeholder="Your first name" />
        </div>
      </div>
      <p id="intro-weave" class="muted" style="margin-top:8px">Welcome, <span id="aliasPreview">traveler</span>. I‚Äôll note your name as <span id="fnamePreview">Friend</span> in the ledger.</p>
      <div class="navhint">Scroll / Arrow keys move section-by-section (snap). Up/down moves immediately.</div>
    </div>
  </section>

  <!-- 2: WHAT -->
  <section id="sec-what" aria-labelledby="h-what">
    <div class="card">
      <div class="icons" aria-hidden="true">üó∫Ô∏è ‚úçÔ∏è</div>
      <h2 id="h-what">What This Challenge Is</h2>
      <p>
        There are five General Conference sessions. You will complete exactly five activities total‚Äîone per session.
        You may include exactly one Freebie. Choose carefully; originality matters for Word Search, Crossword, and Freebie. Notes has modes; Maze/Sudoku are about correct session timing (no originality bonus).
      </p>
      <ul>
        <li>Quiet brainstorm (about a minute, self-guided).</li>
        <li>Plan your five-session lineup using the Order Grid below.</li>
        <li>Read the rules carefully‚Äîbenefits and penalties are explicit and numeric.</li>
      </ul>
    </div>
  </section>

  <!-- 3: RULES & SCOREBOARD (GATED) -->
  <section id="sec-rules" aria-labelledby="h-rules">
    <div id="rules-card" class="card" role="region" aria-label="Rules and scoreboard">
      <div class="icons" aria-hidden="true">üìú üî•</div>
      <h2 id="h-rules">Rules & Scoreboard (Read to Continue)</h2>

      <div class="tbl-title plus">Benefits (green +)</div>
      <table role="table" aria-label="Benefits table">
        <thead>
          <tr role="row">
            <th role="columnheader" scope="col">Category</th>
            <th role="columnheader" scope="col">Reason</th>
            <th role="columnheader" scope="col" class="num plus">From ‚Üí To</th>
          </tr>
        </thead>
        <tbody>
          <tr role="row"><td role="cell"><strong>Base per activity</strong></td><td role="cell">Correct session timing</td><td role="cell" class="num plus">+0 ‚Üí +30</td></tr>
          <tr role="row"><td role="cell"><strong>Word Search originality</strong></td><td role="cell">Overlap tiers</td><td role="cell" class="num plus">+0 ‚Üí +20 (20/15/10/5/0)</td></tr>
          <tr role="row"><td role="cell"><strong>Crossword originality</strong></td><td role="cell">Theme & clue style & counts</td><td role="cell" class="num plus">+0 ‚Üí +20</td></tr>
          <tr role="row"><td role="cell"><strong>Freebie originality</strong></td><td role="cell">Original craft or few-of-something</td><td role="cell" class="num plus">+0 ‚Üí +20</td></tr>
          <tr role="row"><td role="cell"><strong>Notes (one mode)</strong></td><td role="cell">Neat; Note-Taking in unique session or Drawing/Coloring colored</td><td role="cell" class="num plus">+0 ‚Üí +30</td></tr>
          <tr role="row"><td role="cell"><strong>Completion bonus</strong></td><td role="cell">+30 baseline; or +30 plus +5 per full 10 penalty up to +40</td><td role="cell" class="num plus">+30 ‚Üí +40</td></tr>
        </tbody>
      </table>

      <div class="tbl-title minus">Penalties (red ‚àí)</div>
      <table role="table" aria-label="Penalties table">
        <thead>
          <tr role="row">
            <th role="columnheader" scope="col">Category</th>
            <th role="columnheader" scope="col">Reason</th>
            <th role="columnheader" scope="col" class="num minus">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr role="row"><td role="cell"><strong>Near-identical WS/CW</strong></td><td role="cell">Ideas too similar</td><td role="cell" class="num minus">‚àí10</td></tr>
          <tr role="row"><td role="cell"><strong>Exact same order</strong></td><td role="cell">Copying lineup</td><td role="cell" class="num minus">‚àí5</td></tr>
          <tr role="row"><td role="cell"><strong>Gaming/early</strong></td><td role="cell">Wrong session timing</td><td role="cell" class="num minus">= 0 points (for that activity)</td></tr>
          <tr role="row"><td role="cell"><strong>Same coloring page, different colors</strong></td><td role="cell">Derivative coloring</td><td role="cell" class="num minus">= 70% of otherwise-earned</td></tr>
          <tr role="row"><td role="cell"><strong>Exact coloring copy</strong></td><td role="cell">No originality</td><td role="cell" class="num minus">= 0</td></tr>
          <tr role="row"><td role="cell"><strong>Incomplete set</strong></td><td role="cell">4/5 ‚àí20%, 3/5 ‚àí40%, 2/5 ‚àí60%, 1/5 ‚àí80%, 0/5 ‚àí100%</td><td role="cell" class="num minus">‚àí20% ‚Üí ‚àí100%</td></tr>
        </tbody>
      </table>
      <p class="note">Tie-breakers: Tic-Tac-Toe, then Rock-Paper-Scissors. Prize hint: possible reward for highest finisher who completes all five.</p>

      <div style="margin-top:12px;display:flex;align-items:center;gap:10px">
        <input id="rules-ok" type="checkbox" />
        <label for="rules-ok"><strong>I read and understand the rules.</strong></label>
      </div>
      <div class="navhint">You <strong>cannot</strong> scroll down past this section until you check the box above.</div>
    </div>
  </section>

  <!-- 4: ACTIVITIES OVERVIEW -->
  <section id="sec-overview" aria-labelledby="h-overview">
    <div class="card">
      <div class="icons" aria-hidden="true">üß© üó∫Ô∏è</div>
      <h2 id="h-overview">Activities Overview</h2>
      <ul>
        <li><strong>Word Search</strong>: Originality via word overlaps. Needs <strong>Final List ‚â• 8 words</strong>. Two synced input modes: token entry and a 16-slot word bank.</li>
        <li><strong>Crossword</strong>: Choose Theme, Across ‚â•1, Down ‚â•1, Difficulty (Easy/Med/Hard). Grid is pre-made; originality via theme/clue style/counts.</li>
        <li><strong>Notes</strong>: Choose one mode ‚Äî Note-Taking, Drawing, or Coloring ‚Äî and write a Plan.</li>
        <li><strong>Maze or Sudoku</strong>: pick exactly one (xor), Difficulty required; no originality bonus.</li>
        <li><strong>Freebie</strong>: Describe a small craft or ‚Äúfew-of-something.‚Äù</li>
      </ul>
      <p class="muted">Next, place exactly five items (one per session) in the lineup, with exactly one Notes mode, and either Maze or Sudoku.</p>
    </div>
  </section>

  <!-- 5: ORDER GRID (DnD) -->
  <section id="sec-grid" aria-labelledby="h-grid">
    <div class="card" role="region" aria-label="Order grid with drag-and-drop and keyboard controls">
      <div class="icons" aria-hidden="true">üß© üßô‚Äç‚ôÇÔ∏è</div>
      <h2 id="h-grid">Choose Your Five ‚Äî Drag, Drop, or Use Keyboard</h2>
      <p class="muted">Keyboard: Focus a palette item ‚Üí <strong>Alt+1..5</strong> to send to a session. On slots: <strong>Alt+‚Üê/‚Üí</strong> to swap, <strong>Delete</strong> to remove.</p>

      <div class="palette" id="palette" aria-label="Palette">
        <!-- Items are pills; id carries type & variant -->
        <div class="pill" tabindex="0" draggable="true" data-type="wordSearch" id="item-ws">Word Search <small class="badge">Originality</small></div>
        <div class="pill" tabindex="0" draggable="true" data-type="crossword" id="item-cw">Crossword <small class="badge">Originality</small></div>
        <div class="pill" tabindex="0" draggable="true" data-type="notes" data-variant="Note-Taking" id="item-notes-nt">Notes ‚Äî Note-Taking</div>
        <div class="pill" tabindex="0" draggable="true" data-type="notes" data-variant="Drawing" id="item-notes-draw">Notes ‚Äî Drawing</div>
        <div class="pill" tabindex="0" draggable="true" data-type="notes" data-variant="Coloring" id="item-notes-color">Notes ‚Äî Coloring</div>
        <div class="pill" tabindex="0" draggable="true" data-type="maze" id="item-maze">Maze</div>
        <div class="pill" tabindex="0" draggable="true" data-type="sudoku" id="item-sudoku">Sudoku</div>
        <div class="pill" tabindex="0" draggable="true" data-type="freebie" id="item-freebie">Freebie</div>
      </div>

      <div style="margin:14px 0 6px;font-weight:700">Lineup (Sessions 1‚Äì5)</div>
      <div class="slots" id="slots" aria-label="Five session slots">
        <div class="slot" tabindex="0" data-index="0" aria-label="Session 1"><div class="slabel">Session 1</div><div class="inside"></div></div>
        <div class="slot" tabindex="0" data-index="1" aria-label="Session 2"><div class="slabel">Session 2</div><div class="inside"></div></div>
        <div class="slot" tabindex="0" data-index="2" aria-label="Session 3"><div class="slabel">Session 3</div><div class="inside"></div></div>
        <div class="slot" tabindex="0" data-index="3" aria-label="Session 4"><div class="slabel">Session 4</div><div class="inside"></div></div>
        <div class="slot" tabindex="0" data-index="4" aria-label="Session 5"><div class="slabel">Session 5</div><div class="inside"></div></div>
      </div>

      <div id="dnd-aria" class="muted" role="status" aria-live="polite" style="margin-top:10px"></div>
      <div id="constraint-msg" class="bad" role="alert" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- 6: DETAILS (conditional) -->
  <section id="sec-details" aria-labelledby="h-details">
    <div class="card">
      <div class="icons" aria-hidden="true">‚úçÔ∏è üß©</div>
      <h2 id="h-details">Details for Your Chosen Items</h2>
      <p class="muted">Only panels for selected items appear. Ensure required fields are filled.</p>

      <div class="grid" id="details-panels">

        <!-- Word Search -->
        <div class="panel" id="panel-ws" hidden>
          <h3>Word Search</h3>
          <div class="details-grid">
            <div>
              <label for="ws-diff">Difficulty</label>
              <select id="ws-diff" class="input" aria-label="Word search difficulty">
                <option value="">Select‚Ä¶</option>
                <option>Easy</option><option>Medium</option><option>Hard</option>
              </select>
              <div class="note" style="margin-top:6px">Originality via overlaps. Final list must have <strong>‚â• 8</strong> words.</div>
            </div>
            <div>
              <label for="ws-final">Final list (comma-separated)</label>
              <textarea id="ws-final" class="input" rows="4" placeholder="e.g., faith, charity, hope, ..." ></textarea>
              <div class="note">Auto-filled from tokens/bank; you can also edit here.</div>
            </div>
          </div>
          <div style="margin-top:10px">
            <label>Token input (type a word, press space/comma/Enter)</label>
            <div id="ws-tokenbox" class="tokenbox">
              <input id="ws-token-input" class="input" placeholder="type & press space/comma/Enter‚Ä¶" style="min-width:240px;width:auto" />
            </div>
          </div>
          <div style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <label>Word Bank (up to 16)</label>
              <div>
                <button class="secondary" id="bank-add">Add Slot</button>
                <button class="secondary" id="bank-rem">Remove Slot</button>
              </div>
            </div>
            <div id="ws-bank" class="bank" aria-label="Word bank inputs"></div>
          </div>
        </div>

        <!-- Crossword -->
        <div class="panel" id="panel-cw" hidden>
          <h3>Crossword</h3>
          <div class="details-grid">
            <div>
              <label for="cw-theme">Theme</label>
              <input id="cw-theme" class="input" placeholder="e.g., Parables, ‚ÄòMountains & Prophets‚Äô" />
            </div>
            <div class="two grid">
              <div>
                <label for="cw-across">Across count (‚â•1)</label>
                <input id="cw-across" class="input" inputmode="numeric" placeholder="e.g., 4" />
              </div>
              <div>
                <label for="cw-down">Down count (‚â•1)</label>
                <input id="cw-down" class="input" inputmode="numeric" placeholder="e.g., 4" />
              </div>
            </div>
            <div>
              <label for="cw-diff">Difficulty</label>
              <select id="cw-diff" class="input">
                <option value="">Select‚Ä¶</option>
                <option>Easy</option><option>Medium</option><option>Hard</option>
              </select>
            </div>
          </div>
          <div class="note">Grid is pre-made. Originality depends on theme, clue style, and counts.</div>
        </div>

        <!-- Notes -->
        <div class="panel" id="panel-notes" hidden>
          <h3>Notes ‚Äî <span id="notes-mode">Mode</span></h3>
          <label for="notes-plan">Plan</label>
          <textarea id="notes-plan" class="input" rows="4" placeholder="What will you take notes on / draw / color? How will you keep it neat?"></textarea>
        </div>

        <!-- Freebie -->
        <div class="panel" id="panel-freebie" hidden>
          <h3>Freebie</h3>
          <label for="freebie-desc">Description</label>
          <textarea id="freebie-desc" class="input" rows="3" placeholder="Describe your craft or few-of-something."></textarea>
        </div>

        <!-- Puzzle (Maze/Sudoku) -->
        <div class="panel" id="panel-puzzle" hidden>
          <h3 id="puzzle-title">Puzzle</h3>
          <label for="puz-diff">Difficulty</label>
          <select id="puz-diff" class="input">
            <option value="">Select‚Ä¶</option>
            <option>Easy</option><option>Medium</option><option>Hard</option>
          </select>
        </div>

      </div>
    </div>
  </section>

  <!-- 7: SUBMIT / PRINT -->
  <section id="sec-submit" aria-labelledby="h-submit">
    <div class="card">
      <div class="icons" aria-hidden="true">‚úçÔ∏è üìú</div>
      <h2 id="h-submit">Submit & Print (One Shot)</h2>
      <div class="two grid">
        <div>
          <label for="initial">First initial (exactly 1 character)</label>
          <input id="initial" class="input" maxlength="1" placeholder="e.g., H" />
        </div>
        <div class="center">
          <button id="btn-preview" class="secondary">Preview JSON</button>
          <div id="preview" class="muted" style="max-width:75ch;word-break:break-word"></div>
        </div>
      </div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btn-submit">Submit & Open Print Tab</button>
        <button id="btn-reset" class="secondary">Reset Everything (dev/test)</button>
      </div>
      <p class="note">After confirming, a print-ready page opens in a new tab and this tab becomes locked. Hand the printout to the organizer.</p>
    </div>
  </section>
</main>

<!-- Modal (rules nudge + print info) -->
<div class="modal-back" id="modal-back" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-h" aria-describedby="modal-d">
    <h3 id="modal-h">Action Needed</h3>
    <p id="modal-d">Please check ‚ÄúI read and understand the rules.‚Äù to continue.</p>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
      <button id="modal-ok">OK</button>
    </div>
  </div>
</div>

<!-- Modal for print explanation -->
<div class="modal-back" id="print-back" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="print-h" aria-describedby="print-d">
    <h3 id="print-h">Print Your Plan</h3>
    <p id="print-d">We‚Äôll open a new tab with your summary and automatically start printing. Please hand the printout to the organizer. This tab will lock after submission.</p>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
      <button id="print-ok">Open Print Tab</button>
      <button id="print-cancel" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<script>
/*** ===== CONFIG / ACCESS CODES ===== ***/
const ACCESS_CODES = ["1734","4375","2025","0001"]; // /^\d{4}$/
const ADMIN_PIN   = "4317"; // admin-only reset PIN

/*** ===== STATE ===== ***/
const state = {
  user:{ alias:'', firstName:'', initial:'' },
  order:[null,null,null,null,null], // Session 1..5
  details:{
    wordSearch:{ difficulty:'', bank:Array(16).fill(''), final:[] },
    crossword:{ theme:'', across:'', down:'', difficulty:'' },
    notes:{ mode:'', plan:'' }, // 'Note-Taking'|'Drawing'|'Coloring'
    freebie:{ desc:'' },
    puzzle:{ type:'', difficulty:'' } // 'Maze'|'Sudoku' or 'Maze & Sudoku' label on panel
  },
  meta:{ submittedAt:null, locked:false },
};

const KEYS = {
  ACCESS_OK_CODE:'gc_access_ok_code',     // last valid code used to unlock
  ACCESS_OK:'gc_access_ok',               // legacy flag (kept for compatibility)
  LOCKED_CODES:'gc_locked_codes',         // JSON array of codes that have submitted (locked)
  LOCKED_AT_MAP:'gc_locked_at_map',       // JSON map: code -> timestamp
  RULES_ACK:'gc_rules_ack',               // persisted rules checkbox
  PROGRESS:'gc_progress_made'             // "any field was edited" marker
};

/*** ===== CORE REFS ===== ***/
const scroller = document.getElementById('scroller');
let sections = Array.from(scroller.querySelectorAll('section'));
const warp = document.getElementById('warp');

let currentIndex = 0;

/*** ===== RUNTIME STYLES (ensure) ===== ***/
(function ensureRuntimeStyles(){
  const id = 'runtime-helper-style';
  if(!document.getElementById(id)){
    const s = document.createElement('style');
    s.id = id;
    s.textContent = `
      .invalid{ border-color:#FF3B30 !important; box-shadow:0 0 0 2px rgba(255,59,48,.35) !important; }
      .field-hint{ font-size:12px; color:#FF3B30; margin-top:6px; }
      .locked-scroll-freeze{ overflow:hidden !important; height:100vh !important; }
      .card-footer{ margin-top:12px; padding-top:12px; border-top:1px dashed rgba(255,255,255,.25); }
      .nav-rail{position:fixed;inset:auto 0 16px 0;display:flex;justify-content:center;gap:12px;z-index:90;pointer-events:none}
      .nav-rail button{pointer-events:auto;background:#FFD74A;border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
      .nav-rail button:focus{outline:3px solid #9C5BFF}
      /* Gate styles (if we inject it) */
      #sec-gate{display:none}
      .gate-card{background:rgba(18,18,18,.6);border:2px solid rgba(255,255,255,.15);border-radius:16px;padding:28px;color:#F7F5FF;max-width:520px;width:min(92vw,520px);text-align:center}
      .gate-input{width:100%;padding:12px 14px;border-radius:10px;border:2px solid rgba(255,255,255,.25);background:#F7F5FF;color:#121212;font:16px/1.35 system-ui;letter-spacing:2px;text-align:center}
      .gate-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
      .btn{background:#FFD74A;color:#121212;border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
      .btn.alt{background:#9C5BFF;color:#F7F5FF}
      .muted{opacity:.8}
      .wiggle{animation:wig .25s}
      @keyframes wig {0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
    `;
    document.head.appendChild(s);
  }
})();

/*** ===== WARP BG ===== ***/
function setWarpForIndex(i){
  const deg = (i*37)%360;
  const scale = 1 + (i%3)*0.08;
  const tx = (-50 + (i%5)*2);
  const ty = (-50 + ((i+2)%5)*2);
  if(warp) warp.style.transform = `translate(${tx}%,${ty}%) scale(${scale}) rotate(${deg}deg)`;
}
setWarpForIndex(0);

/*** ===== PROGRESS MARKER ===== ***/
function markProgress(){ if(localStorage.getItem(KEYS.PROGRESS)!=='true') localStorage.setItem(KEYS.PROGRESS,'true'); }
function clearProgress(){ localStorage.removeItem(KEYS.PROGRESS); }

/*** ===== ACCESS GATE UI (inject if missing) ===== ***/
function ensureGateUI(){
  let gateSection = document.getElementById('sec-gate');
  if(!gateSection){
    gateSection = document.createElement('section');
    gateSection.id = 'sec-gate';
    scroller.prepend(gateSection);
    sections = Array.from(scroller.querySelectorAll('section')); // refresh
  }
  gateSection.innerHTML = `
    <div class="gate-wrap" style="display:grid;place-items:center;min-height:100vh;background:linear-gradient(145deg,#2A0F45,#3B1D5A);position:fixed;inset:0;z-index:100;">
      <div class="gate-card" role="dialog" aria-modal="true" aria-labelledby="gate-h">
        <div style="font-size:28px" aria-hidden="true">üõ∏ üîë</div>
        <h2 id="gate-h" style="margin:.2em 0 .5em">Enter Access Code</h2>
        <p class="muted">Ask the organizer for your 4-digit code. Entering a code that has already submitted on this browser will show a lock notice for that code. (Only one per person!)</p>
        <input id="code" class="gate-input" inputmode="numeric" autocomplete="one-time-code" maxlength="4" placeholder="0000" aria-label="4-digit access code">
        <div class="gate-actions">
          <button id="btn-enter" class="btn">Enter</button>
          <button id="btn-clear" class="btn alt" title="Admin">Admin Clear</button>
        </div>
        <div id="gate-msg" style="margin-top:10px;min-height:1.3em"></div>
      </div>
    </div>
  `;
  return {
    section: gateSection,
    codeInput: gateSection.querySelector('#code'),
    btnEnter: gateSection.querySelector('#btn-enter'),
    btnClear: gateSection.querySelector('#btn-clear'),
    gateMsg: gateSection.querySelector('#gate-msg')
  };
}
const GATE = ensureGateUI();
const gateSection = GATE.section;
let codeInput = GATE.codeInput;
let btnEnter  = GATE.btnEnter;
let btnClear  = GATE.btnClear;
let gateMsg   = GATE.gateMsg;

/*** ===== LOCK STORAGE HELPERS (code-specific) ===== ***/
function getLockedCodes(){
  try{ return JSON.parse(localStorage.getItem(KEYS.LOCKED_CODES)||'[]'); }catch{ return []; }
}
function getLockedAtMap(){
  try{ return JSON.parse(localStorage.getItem(KEYS.LOCKED_AT_MAP)||'{}'); }catch{ return {}; }
}
function isCodeLocked(code){ return getLockedCodes().includes(code); }
function lockCode(code){
  if(!code) return;
  const set = new Set(getLockedCodes()); set.add(code);
  localStorage.setItem(KEYS.LOCKED_CODES, JSON.stringify([...set]));
  const map = getLockedAtMap(); map[code] = new Date().toLocaleString();
  localStorage.setItem(KEYS.LOCKED_AT_MAP, JSON.stringify(map));
}

/*** ===== FULL-PAGE GATE SHOW/HIDE ===== ***/
function showGate(){
  gateSection.style.display = 'block';
  document.documentElement.classList.add('locked-scroll-freeze');
  document.body.classList.add('locked-scroll-freeze');
  scroller.classList.add('locked-scroll-freeze');
  document.documentElement.style.overflow = 'hidden';
  document.body.style.overflow = 'hidden';
  scroller.style.overflow = 'hidden';
  gateMsg.textContent = '';
  setWarpForIndex(0);
  if (codeInput){ codeInput.readOnly = false; codeInput.removeAttribute('disabled'); codeInput.focus(); }
}
function hideGate(){
  gateSection.style.display = 'none';
  document.documentElement.classList.remove('locked-scroll-freeze');
  document.body.classList.remove('locked-scroll-freeze');
  scroller.classList.remove('locked-scroll-freeze');
  document.documentElement.style.overflow = '';
  document.body.style.overflow = '';
  scroller.style.overflow = '';
  currentIndex = 1; // Intro (first real section)
  sections[1]?.scrollIntoView?.({behavior:'instant'});
  setWarpForIndex(1);
}

/*** ===== STARTUP UNLOCK CHECK ===== ***/
function startUnlockCheck(){
  const saved = localStorage.getItem(KEYS.ACCESS_OK_CODE);
  const hasProgress = localStorage.getItem(KEYS.PROGRESS)==='true';
  // If a previously valid code is saved AND is not locked AND progress was made, auto-unlock; else show gate.
  if(saved && !isCodeLocked(saved) && hasProgress){
    hideGate();
    return;
  }
  // If no progress, force back to passcode page on reload
  if(saved && !hasProgress){
    localStorage.removeItem(KEYS.ACCESS_OK_CODE);
    localStorage.removeItem(KEYS.ACCESS_OK); // legacy
  }
  showGate();
}
startUnlockCheck();

/*** ===== GATE HANDLERS ===== ***/
function shake(el){ el.classList.remove('wiggle'); void el.offsetWidth; el.classList.add('wiggle'); }

function tryUnlock(){
  const v = (codeInput.value||'').trim();
  if(!/^\d{4}$/.test(v)){
    gateMsg.innerHTML = '<span style="color:#FFD74A">Enter a valid 4-digit code (mandatory)</span>';
    shake(codeInput); return;
  }
  if(!ACCESS_CODES.includes(v)){
    gateMsg.innerHTML = '<span style="color:#FF3B30">Code not recognized. Ask the organizer.</span>';
    shake(codeInput); return;
  }
  // If this specific code already submitted on this browser ‚Üí show lock notice now
  if(isCodeLocked(v)){
    const lockedAt = getLockedAtMap()[v] || 'unknown';
    document.body.innerHTML = `
      <div style="display:grid;place-items:center;min-height:100vh;padding:24px;background:linear-gradient(145deg,#2A0F45,#3B1D5A)">
        <div class="gate-card">
          <div style="font-size:28px" aria-hidden="true">üõ∏ üîí</div>
          <h2>Thanks ‚Äî already submitted</h2>
          <p class="muted">This browser is locked for access code <strong>${v}</strong>.</p>
          <p>Submitted at: <strong>${lockedAt}</strong></p>
        </div>
      </div>`;
    return;
  }
  // valid and not locked for this code ‚Üí grant access
  localStorage.setItem(KEYS.ACCESS_OK_CODE, v);
  localStorage.setItem(KEYS.ACCESS_OK, 'true'); // legacy
  gateMsg.innerHTML = '<span style="color:#2FBF71">Access granted. Welcome!</span>';
  hideGate();
}

btnEnter.addEventListener('click', tryUnlock);
codeInput.addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });
btnClear.addEventListener('click', ()=>{
  const entered = prompt('Admin PIN required to clear local access:');
  if (entered !== ADMIN_PIN) { alert('Incorrect admin PIN.'); return; }
  localStorage.removeItem(KEYS.ACCESS_OK_CODE);
  localStorage.removeItem(KEYS.ACCESS_OK);
  gateMsg.textContent = 'Local access flag cleared. Re-enter a code.';
  codeInput.focus();
});

/*** ===== INTRO WEAVE ===== ***/
const aliasEl = document.getElementById('alias');
const fnameEl = document.getElementById('fname');
const aliasPreview = document.getElementById('aliasPreview');
const fnamePreview = document.getElementById('fnamePreview');
function updateWeave(){
  state.user.alias = (aliasEl?.value||'').trim();
  state.user.firstName = (fnameEl?.value||'').trim();
  if(aliasPreview) aliasPreview.textContent = state.user.alias || 'traveler';
  if(fnamePreview) fnamePreview.textContent = state.user.firstName || 'Friend';
  markProgress();
}
aliasEl?.addEventListener('input', updateWeave);
fnameEl?.addEventListener('input', updateWeave);

/*** ===== REQUIRED FIELD HELPERS ===== ***/
function ensureHint(el){
  let hint = el.nextElementSibling && el.nextElementSibling.classList?.contains('field-hint')
    ? el.nextElementSibling : null;
  if(!hint){
    hint = document.createElement('div');
    hint.className = 'field-hint';
    el.insertAdjacentElement('afterend', hint);
  }
  return hint;
}
function markInvalid(el, msg='Mandatory field'){
  if(!el) return; el.classList.add('invalid'); el.setAttribute('aria-invalid','true');
  ensureHint(el).textContent = `Mandatory: ${msg}`;
}
function clearInvalid(el){
  if(!el) return; el.classList.remove('invalid'); el.removeAttribute('aria-invalid');
  const n = el.nextElementSibling; if(n && n.classList?.contains('field-hint')) n.textContent = '';
}

/*** ===== RULES ACKNOWLEDGE (persisted) ===== ***/
function ensureRulesAcknowledgeUI(){
  let rulesOk = document.getElementById('rules-ok');
  const rulesCard = document.getElementById('rules-card') || document.querySelector('#sec-rules .card');
  if(!rulesOk && rulesCard){
    const footer = rulesCard.querySelector('.card-footer') || rulesCard.appendChild(document.createElement('div'));
    footer.classList.add('card-footer');
    const wrap = document.createElement('label');
    Object.assign(wrap.style,{display:'flex',alignItems:'center',gap:'10px',marginTop:'12px'});
    rulesOk = document.createElement('input'); rulesOk.type='checkbox'; rulesOk.id='rules-ok';
    const span = document.createElement('span'); span.textContent='I have read and understand the rules (mandatory)';
    wrap.appendChild(rulesOk); wrap.appendChild(span); footer.appendChild(wrap);
  }
  const persisted = localStorage.getItem(KEYS.RULES_ACK)==="true";
  if(rulesOk) rulesOk.checked = persisted;
  if(rulesOk && !rulesOk._persistHooked){
    rulesOk.addEventListener('change', ()=>{ localStorage.setItem(KEYS.RULES_ACK, rulesOk.checked?"true":"false"); markProgress(); });
    rulesOk._persistHooked = true;
  }
  return rulesOk || null;
}
function getRulesChecked(){ return localStorage.getItem(KEYS.RULES_ACK)==="true"; }
function setRulesChecked(v){
  localStorage.setItem(KEYS.RULES_ACK, v?"true":"false");
  let el = document.getElementById('rules-ok'); if(!el) el = ensureRulesAcknowledgeUI();
  if(el) el.checked = !!v;
  if(v) markProgress();
}
ensureRulesAcknowledgeUI();

/*** ===== MODAL (rules) ===== ***/
const modalBack = document.getElementById('modal-back');
const modalOk   = document.getElementById('modal-ok');
function showModal(msg, opts={}){
  const isRules = opts.type === 'rules';
  const content = document.getElementById('modal-d');
  content.innerHTML = '';
  const p = document.createElement('p'); p.textContent = msg || ''; content.appendChild(p);
  if(isRules){
    const wrap = document.createElement('label'); Object.assign(wrap.style,{display:'flex',alignItems:'center',gap:'10px',marginTop:'12px'});
    const mChk = document.createElement('input'); mChk.type='checkbox'; mChk.id='modal-rules-ok';
    const span = document.createElement('span'); span.textContent = 'I have read and understand the rules (mandatory)';
    wrap.appendChild(mChk); wrap.appendChild(span); content.appendChild(wrap);
    mChk.checked = getRulesChecked();
    mChk.addEventListener('change', ()=>{ setRulesChecked(mChk.checked); if(mChk.checked) hideModal(); });
  }
  modalBack.classList.add('show');
  (modalBack.querySelector('.modal') || modalBack).focus();
}
function hideModal(){ modalBack.classList.remove('show'); }
modalOk?.addEventListener('click', ()=>{ const mChk = document.getElementById('modal-rules-ok'); if(mChk){ setRulesChecked(mChk.checked); } hideModal(); });
modalBack?.addEventListener('click', (e)=>{ if(e.target===modalBack) hideModal(); });
document.addEventListener('change', (e)=>{ if(e.target?.id==='rules-ok' && e.target.checked){ hideModal(); }});

/*** ===== DnD & LINEUP ===== ***/
const palette = document.getElementById('palette');
const slots = Array.from(document.querySelectorAll('.slot'));
const ariaDnd = document.getElementById('dnd-aria');
const constraintMsg = document.getElementById('constraint-msg');
function announce(msg){ if(ariaDnd) ariaDnd.textContent = msg; }

function pillTemplate(label, type, variant){
  const span = document.createElement('span'); span.textContent = label;
  const wrap = document.createElement('span'); wrap.className='smallpill'; wrap.setAttribute('draggable','false');
  wrap.dataset.type = type; if(variant) wrap.dataset.variant = variant;
  wrap.appendChild(span);
  const x = document.createElement('button'); x.className='xbtn'; x.type='button'; x.setAttribute('aria-label','Remove'); x.textContent='√ó';
  x.addEventListener('click', ()=>{
    const slot = wrap.closest('.slot'); slot.querySelector('.inside').innerHTML='';
    const idx = +slot.dataset.index; state.order[idx]=null; syncDetailsVisibility(); validateConstraints(); markProgress();
  });
  wrap.appendChild(x);
  return wrap;
}
function labelFor(type, variant){
  if(type==='notes') return `Notes ‚Äî ${variant}`;
  if(type==='wordSearch') return 'Word Search';
  if(type==='crossword') return 'Crossword';
  if(type==='maze') return 'Maze';
  if(type==='sudoku') return 'Sudoku';
  if(type==='freebie') return 'Freebie';
  return type;
}
function placeInSlot(slotIndex, type, variant){
  const slot = slots[slotIndex]; const inside = slot.querySelector('.inside');
  inside.innerHTML=''; inside.appendChild(pillTemplate(labelFor(type,variant), type, variant));
  state.order[slotIndex] = {type, variant: variant||''};
  syncDetailsVisibility(); validateConstraints(); announce(`Placed ${labelFor(type,variant)} in Session ${slotIndex+1}.`);
  markProgress();
}
palette?.addEventListener('dragstart', (e)=>{
  const pill = e.target.closest('.pill'); if(!pill) return;
  e.dataTransfer.setData('text/plain', JSON.stringify({ type:pill.dataset.type, variant:pill.dataset.variant||'' }));
});
slots.forEach(slot=>{
  slot.addEventListener('dragover', e=>{ e.preventDefault(); });
  slot.addEventListener('drop', e=>{
    e.preventDefault();
    const data = JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
    if(!data.type) return; placeInSlot(+slot.dataset.index, data.type, data.variant||'');
  });
  // keyboard manage
  slot.addEventListener('keydown', (e)=>{
    const idx = +slot.dataset.index;
    if(e.key==='Delete' || e.key==='Backspace'){
      const inside = slot.querySelector('.inside'); if(inside.childElementCount){ inside.innerHTML=''; state.order[idx]=null; syncDetailsVisibility(); validateConstraints(); markProgress(); }
    }
    if(e.altKey && !e.shiftKey && !e.ctrlKey && !e.metaKey){
      if(e.key==='ArrowLeft' && idx>0){ e.preventDefault(); const a=state.order[idx-1], b=state.order[idx]; state.order[idx-1]=b; state.order[idx]=a; renderSlotsFromState(); markProgress(); }
      if(e.key==='ArrowRight' && idx<4){ e.preventDefault(); const a=state.order[idx+1], b=state.order[idx]; state.order[idx+1]=b; state.order[idx]=a; renderSlotsFromState(); markProgress(); }
    }
  });
});
function renderSlotsFromState(){
  slots.forEach((slot,i)=>{
    const inside = slot.querySelector('.inside'); inside.innerHTML='';
    const it = state.order[i]; if(it){ inside.appendChild(pillTemplate(labelFor(it.type,it.variant), it.type, it.variant)); }
  });
  syncDetailsVisibility(); validateConstraints();
}

/*** ===== CONSTRAINTS (Maze & Sudoku allowed; Freebie mandatory) ===== ***/
function validateConstraints(){
  if(!constraintMsg) return true;
  constraintMsg.textContent = '';
  const chosen = state.order.filter(Boolean);
  const count = chosen.length;
  const notesCount = chosen.filter(x=>x.type==='notes').length;
  const freebieCount = chosen.filter(x=>x.type==='freebie').length;

  let errors = [];
  if(count!==5) errors.push(`Choose exactly 5 items (currently ${count}).`);
  if(notesCount!==1) errors.push(`Include exactly one Notes mode (currently ${notesCount}).`);
  if(freebieCount!==1) errors.push(`Freebie is mandatory: include exactly one Freebie (currently ${freebieCount}).`);

  if(errors.length){ constraintMsg.textContent = errors.join(' '); return false; }
  return true;
}

/*** ===== DETAILS PANELS ===== ***/
const panels = {
  ws: document.getElementById('panel-ws'),
  cw: document.getElementById('panel-cw'),
  notes: document.getElementById('panel-notes'),
  freebie: document.getElementById('panel-freebie'),
  puzzle: document.getElementById('panel-puzzle'),
};
const notesModeEl = document.getElementById('notes-mode');
const puzzleTitle = document.getElementById('puzzle-title');

function chosenTypes(){
  const chosen = state.order.filter(Boolean);
  return {
    ws: chosen.some(x=>x.type==='wordSearch'),
    cw: chosen.some(x=>x.type==='crossword'),
    notes: chosen.find(x=>x.type==='notes')?.variant || '',
    freebie: chosen.some(x=>x.type==='freebie'),
    maze: chosen.some(x=>x.type==='maze'),
    sudoku: chosen.some(x=>x.type==='sudoku'),
  };
}
function syncDetailsVisibility(){
  const c = chosenTypes();
  if(panels.ws) panels.ws.hidden = !c.ws;
  if(panels.cw) panels.cw.hidden = !c.cw;
  if(panels.notes) panels.notes.hidden = !c.notes;
  if(panels.freebie) panels.freebie.hidden = !c.freebie;
  const anyPuzzle = (c.maze || c.sudoku);
  if(panels.puzzle) panels.puzzle.hidden = !anyPuzzle;
  if(c.notes){ state.details.notes.mode = c.notes; if(notesModeEl) notesModeEl.textContent = c.notes; }
  if(c.maze && !c.sudoku){ state.details.puzzle.type='Maze'; if(puzzleTitle) puzzleTitle.textContent='Puzzle ‚Äî Maze'; }
  else if(!c.maze && c.sudoku){ state.details.puzzle.type='Sudoku'; if(puzzleTitle) puzzleTitle.textContent='Puzzle ‚Äî Sudoku'; }
  else if(c.maze && c.sudoku){ state.details.puzzle.type='Maze & Sudoku'; if(puzzleTitle) puzzleTitle.textContent='Puzzle ‚Äî Maze & Sudoku'; }
}

/*** ===== WORD SEARCH ===== ***/
const wsDiff = document.getElementById('ws-diff');
const wsFinal = document.getElementById('ws-final');
const wsTokenInput = document.getElementById('ws-token-input');
const wsTokenBox = document.getElementById('ws-tokenbox');
const wsBank = document.getElementById('ws-bank');
const bankAdd = document.getElementById('bank-add');
const bankRem = document.getElementById('bank-rem');
let wsTokens = [];
function renderTokens(){
  Array.from(wsTokenBox?.querySelectorAll('.token')||[]).forEach(n=>n.remove());
  wsTokens.forEach((t,i)=>{
    const el = document.createElement('span'); el.className='token'; el.textContent = t;
    const b = document.createElement('button'); b.className='xbtn'; b.textContent='√ó'; b.type='button'; b.setAttribute('aria-label',`Remove ${t}`);
    b.addEventListener('click', ()=>{ wsTokens.splice(i,1); syncWsFinal(); renderTokens(); markProgress(); });
    el.appendChild(b); wsTokenBox?.insertBefore(el, wsTokenInput||null);
  });
}
function syncWsFinal(){
  const bankVals = (state.details.wordSearch.bank||[]).filter(Boolean).map(s=>s.trim()).filter(Boolean);
  const all = Array.from(new Set([...wsTokens, ...bankVals]));
  state.details.wordSearch.final = all; if(wsFinal) wsFinal.value = all.join(', ');
}
wsTokenInput?.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' || e.key===' ' || e.key===',' ){
    e.preventDefault(); const v = wsTokenInput.value.trim().replace(/,+/g,'');
    if(v){ wsTokens.push(v); wsTokenInput.value=''; renderTokens(); syncWsFinal(); markProgress(); }
  }
});
wsFinal?.addEventListener('input', ()=>{ const list = wsFinal.value.split(',').map(s=>s.trim()).filter(Boolean); state.details.wordSearch.final = list; markProgress(); });
function renderBank(){
  if(!wsBank) return;
  wsBank.innerHTML=''; state.details.wordSearch.bank.forEach((val,idx)=>{
    const inp = document.createElement('input'); inp.className='input'; inp.placeholder=`Word ${idx+1}`; inp.value = val||'';
    inp.addEventListener('input', ()=>{ state.details.wordSearch.bank[idx] = inp.value.trim(); syncWsFinal(); markProgress(); }); wsBank.appendChild(inp);
  });
}
bankAdd?.addEventListener('click', ()=>{ if(state.details.wordSearch.bank.length<16){ state.details.wordSearch.bank.push(''); renderBank(); syncWsFinal(); markProgress(); }});
bankRem?.addEventListener('click', ()=>{ if(state.details.wordSearch.bank.length>0){ state.details.wordSearch.bank.pop(); renderBank(); syncWsFinal(); markProgress(); }});
wsDiff?.addEventListener('change', ()=>{ state.details.wordSearch.difficulty = wsDiff.value; markProgress(); });

/*** ===== CROSSWORD ===== ***/
const cwTheme = document.getElementById('cw-theme');
const cwAcross = document.getElementById('cw-across');
const cwDown  = document.getElementById('cw-down');
const cwDiff  = document.getElementById('cw-diff');
[cwTheme,cwAcross,cwDown,cwDiff].forEach(el=>{
  el?.addEventListener('input', ()=>{
    state.details.crossword.theme = cwTheme.value.trim();
    state.details.crossword.across = cwAcross.value.trim();
    state.details.crossword.down   = cwDown.value.trim();
    state.details.crossword.difficulty = cwDiff.value;
    markProgress();
  });
});

/*** ===== NOTES / FREEBIE / PUZZLE ===== ***/
const notesPlan = document.getElementById('notes-plan');
notesPlan?.addEventListener('input', ()=>{ state.details.notes.plan = notesPlan.value.trim(); markProgress(); });
const freeDesc = document.getElementById('freebie-desc');
freeDesc?.addEventListener('input', ()=>{ state.details.freebie.desc = freeDesc.value.trim(); markProgress(); });
const puzDiff = document.getElementById('puz-diff');
puzDiff?.addEventListener('change', ()=>{ state.details.puzzle.difficulty = puzDiff.value; markProgress(); });

/*** ===== SUBMIT / PRINT ===== ***/
const initialEl  = document.getElementById('initial');
const btnPreview = document.getElementById('btn-preview');
const preview    = document.getElementById('preview');
const btnSubmit  = document.getElementById('btn-submit');
const btnReset   = document.getElementById('btn-reset');
const printBack  = document.getElementById('print-back');
const printOk    = document.getElementById('print-ok');
const printCancel= document.getElementById('print-cancel');

initialEl?.addEventListener('input', ()=>{ state.user.initial = initialEl.value.trim(); markProgress(); });
btnPreview?.addEventListener('click', ()=>{ const snap = snapshot(); if(preview) preview.textContent = JSON.stringify(snap,null,2); });
btnReset?.addEventListener('click', ()=>{
  const entered = prompt('Admin PIN required to reset local data:');
  if (entered !== ADMIN_PIN){ alert('Incorrect admin PIN.'); return; }
  if(confirm('Reset localStorage (access, locks, rules, progress) and reload?')){
    localStorage.removeItem(KEYS.ACCESS_OK_CODE);
    localStorage.removeItem(KEYS.ACCESS_OK);
    localStorage.removeItem(KEYS.LOCKED_CODES);
    localStorage.removeItem(KEYS.LOCKED_AT_MAP);
    localStorage.removeItem(KEYS.RULES_ACK);
    clearProgress();
    location.reload();
  }
});
btnSubmit?.addEventListener('click', ()=>{
  const ok = validateAll(); if(!ok) return;
  printBack.classList.add('show');
});
printCancel?.addEventListener('click', ()=>printBack.classList.remove('show'));
printBack?.addEventListener('click', (e)=>{ if(e.target===printBack) printBack.classList.remove('show'); });
printOk?.addEventListener('click', ()=>{
  printBack.classList.remove('show');
  const data = snapshot(); openPrintTab(data);
  // Lock THIS code only:
  const code = localStorage.getItem(KEYS.ACCESS_OK_CODE) || '';
  lockCode(code);
  state.meta.locked = true; state.meta.submittedAt = new Date().toLocaleString();
  // Show thanks (immediate)
  document.body.innerHTML = `
    <div style="display:grid;place-items:center;min-height:100vh;padding:24px;background:linear-gradient(145deg,#2A0F45,#3B1D5A)">
      <div class="gate-card">
        <div style="font-size:28px" aria-hidden="true">üõ∏ üî•</div>
        <h2>Thanks ‚Äî submitted!</h2>
        <p class="muted">This browser is now locked for access code <strong>${code||'‚Äî'}</strong>.</p>
        <p>Submitted at: <strong>${state.meta.submittedAt}</strong></p>
      </div>
    </div>`;
});

/*** ===== VALIDATION (sections + final) ===== ***/
function validateIntroSection(){
  let ok = true;
  if(!aliasEl?.value.trim()){ markInvalid(aliasEl,'Enter a Legend Alias'); ok=false; } else { clearInvalid(aliasEl); }
  if(!fnameEl?.value.trim()){ markInvalid(fnameEl,'Enter your real first name'); ok=false; } else { clearInvalid(fnameEl); }
  if(!ok){ const card = document.querySelector('#sec-intro .card'); card && (card.classList.remove('wiggle'), card.offsetWidth, card.classList.add('wiggle')); (document.querySelector('#sec-intro .invalid')||aliasEl).focus(); }
  return ok;
}
function validateGridSection(){
  const ok = validateConstraints();
  const card = document.querySelector('#sec-grid .card');
  if(!ok){ card && (card.classList.remove('wiggle'), card.offsetWidth, card.classList.add('wiggle')); constraintMsg?.scrollIntoView({behavior:'smooth', block:'nearest'}); }
  return ok;
}
function validateDetailsSection(){
  let ok = true;
  const ct = chosenTypes();
  if(ct.ws){
    if(!wsDiff?.value){ markInvalid(wsDiff,'Choose difficulty'); ok=false; } else { clearInvalid(wsDiff); }
    const list = (state.details.wordSearch.final||[]);
    if(list.length<8){ markInvalid(wsFinal,'Provide ‚â• 8 words (comma-separated)'); ok=false; } else { clearInvalid(wsFinal); }
  }
  if(ct.cw){
    if(!cwTheme?.value.trim()){ markInvalid(cwTheme,'Provide a theme'); ok=false; } else { clearInvalid(cwTheme); }
    const a = parseInt(cwAcross?.value||'0',10), d = parseInt(cwDown?.value||'0',10);
    if(!(a>=1)){ markInvalid(cwAcross,'Across count ‚â• 1'); ok=false; } else { clearInvalid(cwAcross); }
    if(!(d>=1)){ markInvalid(cwDown,'Down count ‚â• 1'); ok=false; } else { clearInvalid(cwDown); }
    if(!cwDiff?.value){ markInvalid(cwDiff,'Choose difficulty'); ok=false; } else { clearInvalid(cwDiff); }
  }
  if(ct.notes){ if(!notesPlan?.value.trim()){ markInvalid(notesPlan,'Describe your plan'); ok=false; } else { clearInvalid(notesPlan); } }
  if(ct.freebie){ if(!freeDesc?.value.trim()){ markInvalid(freeDesc,'Describe your Freebie'); ok=false; } else { clearInvalid(freeDesc); } }
  if(ct.maze || ct.sudoku){ if(!puzDiff?.value){ markInvalid(puzDiff,'Choose difficulty'); ok=false; } else { clearInvalid(puzDiff); } }
  if(!ok){ const card = document.querySelector('#sec-details .card'); card && (card.classList.remove('wiggle'), card.offsetWidth, card.classList.add('wiggle')); const firstInvalid = document.querySelector('#sec-details .invalid'); (firstInvalid||notesPlan||wsFinal)?.focus(); }
  return ok;
}
const sectionValidators = { 'sec-intro':validateIntroSection, 'sec-grid':validateGridSection, 'sec-details':validateDetailsSection };
function validateAll(){
  state.user.alias = aliasEl?.value.trim()||'';
  state.user.firstName = fnameEl?.value.trim()||'';
  const initialEl2 = document.getElementById('initial');
  state.user.initial = (initialEl2?.value||'').trim();
  let ok = true;
  if(!state.user.alias){ markInvalid(aliasEl,'Enter a Legend Alias'); ok=false; } else { clearInvalid(aliasEl); }
  if(!state.user.firstName){ markInvalid(fnameEl,'Enter your real first name'); ok=false; } else { clearInvalid(fnameEl); }
  if(!state.user.initial || state.user.initial.length!==1){ markInvalid(initialEl2,'Enter exactly 1 initial'); ok=false; } else { clearInvalid(initialEl2); }
  if(!ok){ (document.querySelector('.invalid')||aliasEl)?.focus(); return false; }
  if(!validateConstraints()){
    alert('Fix lineup constraints before submitting.\nNote: Freebie is mandatory and must occupy one slot.');
    return false;
  }
  const ct = chosenTypes();
  if(ct.ws){
    if(!state.details.wordSearch.difficulty){ markInvalid(wsDiff,'Choose difficulty'); return false; }
    if((state.details.wordSearch.final||[]).length<8){ markInvalid(wsFinal,'Provide ‚â• 8 words (comma-separated)'); return false; }
  }
  if(ct.cw){
    const {theme, across, down, difficulty} = state.details.crossword;
    const a = parseInt(across||'0',10), d = parseInt(down||'0',10);
    if(!theme){ markInvalid(cwTheme,'Provide a theme'); return false; }
    if(!(a>=1)){ markInvalid(cwAcross,'Across count ‚â• 1'); return false; }
    if(!(d>=1)){ markInvalid(cwDown,'Down count ‚â• 1'); return false; }
    if(!difficulty){ markInvalid(cwDiff,'Choose difficulty'); return false; }
  }
  if(ct.notes){ if(!state.details.notes.plan){ markInvalid(notesPlan,'Describe your plan'); return false; } }
  if(ct.freebie){ if(!state.details.freebie.desc){ markInvalid(freeDesc,'Describe your Freebie'); return false; } }
  if(ct.maze || ct.sudoku){ if(!state.details.puzzle.difficulty){ markInvalid(puzDiff,'Choose difficulty'); return false; } }
  return true;
}

/*** ===== PRINT TAB ===== ***/
function snapshot(){
  return { user:{...state.user}, order:[...state.order], details: JSON.parse(JSON.stringify(state.details)), meta:{ submittedAt:new Date().toISOString(), locked: state.meta.locked } };
}
function openPrintTab(data){
  const w = window.open('', '_blank');
  const css = `
    body{font:14px/1.4 system-ui;margin:24px;color:#111}
    h1,h2{margin:.2em 0 .5em}
    .grid{display:grid;gap:8px}
    .two{grid-template-columns:1fr 1fr}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #444;padding:6px 8px;vertical-align:top}
    .box{border:1px solid #444;border-radius:8px;padding:10px;margin-top:10px}
    .muted{opacity:.8}
    @media print {.no-print{display:none}}
  `;
  const safe = (s)=>String(s||'').replace(/[&<>]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
  const lineupRows = data.order.map((it, i)=>{
    if(!it) return `<tr><td>${i+1}</td><td>‚Äî</td></tr>`;
    const label = it.type==='notes' ? `Notes ‚Äî ${it.variant}` : labelFor(it.type, it.variant);
    return `<tr><td>${i+1}</td><td>${safe(label)}</td></tr>`;
  }).join('');
  const ws = data.details.wordSearch||{}, cw=data.details.crossword||{}, nt=data.details.notes||{}, fr=data.details.freebie||{}, pz=data.details.puzzle||{};
  const html = `
<!doctype html><html><head><meta charset="utf-8"><title>Print ‚Äî Originals Challenge</title>
<style>${css}</style></head><body>
  <h1>General Conference Originals ‚Äî Print Summary</h1>
  <div class="grid two">
    <div class="box"><h2>Participant</h2>
      <div><strong>Alias:</strong> ${safe(data.user.alias)}</div>
      <div><strong>First Name:</strong> ${safe(data.user.firstName)}</div>
      <div><strong>Initial:</strong> ${safe(data.user.initial)}</div>
    </div>
    <div class="box"><h2>Lineup (Sessions 1‚Äì5)</h2>
      <table><thead><tr><th>Session</th><th>Activity</th></tr></thead><tbody>${lineupRows}</tbody></table>
    </div>
  </div>
  <div class="box"><h2>Details</h2>
    ${ data.order.some(x=>x?.type==='wordSearch') ? `<h3>Word Search</h3><div><strong>Difficulty:</strong> ${safe(ws.difficulty)}</div><div><strong>Final List:</strong> ${safe((ws.final||[]).join(', '))}</div>`:''}
    ${ data.order.some(x=>x?.type==='crossword') ? `<h3>Crossword</h3><div><strong>Theme:</strong> ${safe(cw.theme)}</div><div><strong>Across / Down:</strong> ${safe(cw.across)} / ${safe(cw.down)}</div><div><strong>Difficulty:</strong> ${safe(cw.difficulty)}</div>`:''}
    ${ data.order.some(x=>x?.type==='notes') ? `<h3>Notes ‚Äî ${safe(nt.mode)}</h3><div><strong>Plan:</strong> ${safe(nt.plan)}</div>`:''}
    ${ data.order.some(x=>x?.type==='freebie') ? `<h3>Freebie</h3><div><strong>Description:</strong> ${safe(fr.desc)}</div>`:''}
    ${ data.order.some(x=>x?.type==='maze' || x?.type==='sudoku') ? `<h3>Puzzle ‚Äî ${safe(pz.type)}</h3><div><strong>Difficulty:</strong> ${safe(pz.difficulty)}</div>`:''}
  </div>
  <p class="muted">Generated: ${new Date().toLocaleString()}</p>
  <button class="no-print" onclick="window.print()">Print</button>
  <script>window.addEventListener('load', ()=>{ try{ window.print(); }catch{} });<\\/script>
</body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
}

/*** ===== KEEP FIELDS ACCESSIBLE AT ALL TIMES ===== ***/
function ensureSectionFullyVisible(sec){
  if(!sec) return;
  scroller.scrollTop = sec.offsetTop;
  requestAnimationFrame(()=>{ scroller.scrollTop = sec.offsetTop; });
}
function focusFirstInteractive(sec){
  const focusable = sec.querySelector('input,select,textarea,button,[tabindex]:not([tabindex="-1"])');
  (focusable || sec).focus({preventScroll:true});
}
scroller.addEventListener('focusin', (e)=>{
  const el = e.target;
  if(!(el instanceof HTMLElement)) return;
  const vr = scroller.getBoundingClientRect();
  const er = el.getBoundingClientRect();
  if(er.top < vr.top + 80 || er.bottom > vr.bottom - 20){
    el.scrollIntoView({behavior:'smooth', block:'center'});
  }
});

/*** ===== PREV/NEXT NAV (buttons only; no wheel paging) ===== ***/
function ensureNavButtons(){
  let nav = document.getElementById('nav-rail');
  if(!nav){
    nav = document.createElement('div'); nav.id='nav-rail'; nav.className='nav-rail';
    const prev = document.createElement('button'); prev.id='btn-prev'; prev.type='button'; prev.textContent='‚óÄ Previous';
    const next = document.createElement('button'); next.id='btn-next'; next.type='button'; next.textContent='Next ‚ñ∂';
    nav.appendChild(prev); nav.appendChild(next); document.body.appendChild(nav);
  }
  return { prev: document.getElementById('btn-prev'), next: document.getElementById('btn-next') };
}
const navBtns = ensureNavButtons();
navBtns.prev.addEventListener('click', ()=> prev());
navBtns.next.addEventListener('click', ()=> next());

// Block wheel/PageUp/PageDown/Arrows as paging controls
scroller.addEventListener('wheel', (e)=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});
document.addEventListener('keydown', (e)=>{
  const blockKeys = new Set(['ArrowDown','ArrowUp','PageDown','PageUp','Home','End']);
  if(blockKeys.has(e.key)) { e.preventDefault(); }
});

/*** ===== SECTION NAVIGATION ===== ***/
function goToIndex(i, cause=''){
  i = Math.max(0, Math.min(sections.length-1, i));

  // Ensure rules checkbox exists & persisted state is applied
  ensureRulesAcknowledgeUI();

  // Rules gate: cannot go past Rules unless acknowledged
  const rulesIdx = sections.findIndex(s=>s.id==='sec-rules');
  if(cause==='down' && currentIndex===rulesIdx && i>rulesIdx && !getRulesChecked()){
    const card = document.getElementById('rules-card') || document.querySelector('#sec-rules .card');
    if(card){ card.classList.remove('wiggle'); void card.offsetWidth; card.classList.add('wiggle'); }
    showModal('Please confirm you‚Äôve read the rules by checking the box. After that, click Next again.', { type:'rules' });
    return;
  }

  // Section-level validators when moving down
  const currentSection = sections[currentIndex];
  const currentId = currentSection?.id;
  if(cause==='down' && currentId && sectionValidators[currentId]){
    const ok = sectionValidators[currentId]();
    if(!ok) return;
  }

  currentIndex = i;
  const sec = sections[i];
  ensureSectionFullyVisible(sec);
  setWarpForIndex(i);
  focusFirstInteractive(sec);
}
function next(){ goToIndex(currentIndex+1, 'down'); }
function prev(){ goToIndex(currentIndex-1, 'up'); }

/*** ===== DEV TEST HOTKEY (sequence 4-4-6-9-1) ‚Äî NO BUTTON ===== ***/
let devSeq = [];
const targetSeq = ['4','4','6','9','1'];
document.addEventListener('keydown', (e)=>{
  if(e.repeat) return;
  devSeq.push(e.key);
  if(devSeq.length > targetSeq.length) devSeq.shift();
  if(JSON.stringify(devSeq) === JSON.stringify(targetSeq)){ devFillAll(); devSeq = []; }
});
function devFillAll(){
  // Intro
  if(aliasEl){ aliasEl.value = 'Star-Path Voyager'; }
  if(fnameEl){ fnameEl.value = 'Avery'; }
  updateWeave();

  // Lineup: WS, Notes‚ÄîDrawing, Freebie, Maze, Sudoku
  state.order = [
    {type:'wordSearch'},
    {type:'notes',variant:'Drawing'},
    {type:'freebie'},
    {type:'maze'},
    {type:'sudoku'}
  ];
  renderSlotsFromState();

  // WS details
  if(wsDiff){ wsDiff.value='Medium'; state.details.wordSearch.difficulty='Medium'; }
  wsTokens = ['faith','kindness','patience','service','hope','charity','unity','prayer'];
  renderTokens();
  state.details.wordSearch.bank = ['study','listen','ponder','sing','share','create','write','draw'];
  renderBank(); syncWsFinal();

  // Notes
  state.details.notes.mode='Drawing'; if(notesModeEl) notesModeEl.textContent='Drawing';
  if(notesPlan){ notesPlan.value='Sketch impressions with colored pencils'; notesPlan.dispatchEvent(new Event('input')); }

  // Freebie
  if(freeDesc){ freeDesc.value='Fold 5 paper stars and gift 2'; freeDesc.dispatchEvent(new Event('input')); }

  // Puzzle difficulty (shared)
  if(puzDiff){ puzDiff.value='Hard'; puzDiff.dispatchEvent(new Event('change')); }

  // Identity initial
  const initInput = document.getElementById('initial');
  if(initInput){ initInput.value='A'; initInput.dispatchEvent(new Event('input')); }

  // Rules acknowledged
  setRulesChecked(true);

  // mark progress
  markProgress();

  // Jump to submit
  const submitIdx = sections.findIndex(s=>s.id==='sec-submit');
  goToIndex(submitIdx>=0?submitIdx:sections.length-1, 'down');
}

/*** ===== INIT DETAILS UI ===== ***/
renderBank(); renderTokens(); syncWsFinal();

/*** ===== SECTION COLORS (unchanged thematic) ===== ***/
const sectionBg = [
  'linear-gradient(145deg,#2A0F45,#3B1D5A)', // gate (overlay)
  'linear-gradient(145deg,#3B1D5A,#2A0F45)', // intro
  'linear-gradient(145deg,#2A0F45,#3B1D5A)', // what
  'linear-gradient(145deg,#3B1D5A,#2A0F45)', // rules
  'linear-gradient(145deg,#2A0F45,#3B1D5A)', // overview
  'linear-gradient(145deg,#3B1D5A,#2A0F45)', // grid
  'linear-gradient(145deg,#2A0F45,#3B1D5A)', // details
  'linear-gradient(145deg,#3B1D5A,#2A0F45)', // submit
];
sections.forEach((sec,i)=>{ if(i>0) sec.style.background = sectionBg[i%sectionBg.length]; }); // gate is fixed overlay
</script>


</body>
</html>